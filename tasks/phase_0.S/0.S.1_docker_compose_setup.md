# Task 0.S.1: Docker Compose Stack Setup

**Phase:** 0.S (Shared Infrastructure)  
**Owner:** workflow-engine team (lead), PlayRAGNA team (validation)  
**Effort:** 5 hours  
**Priority:** 🔴 CRITICAL (Blocking Phase 3.2, 0.3)  
**Status:** ⏳ PENDING

---

## 🎯 OBJECTIVE

Create Docker Compose orchestration for FlowForge shared infrastructure services (Ollama, RAGNA, Prometheus, Grafana).

---

## ✅ SUB-TASKS

### Infrastructure Setup
- [x] Create `shared-infrastructure/` directory structure (30 min)
- [x] Write `docker-compose.yml` with all services (2h)
- [x] Create `.env.example` with all configuration variables (1h)
- [x] Write `scripts/install.sh` for automated setup (1h)
- [x] Write `scripts/health-check.sh` for service validation (30 min)
- [ ] Write `scripts/update.sh` (unified upgrade) (1h)
- [ ] Write `README.md` (quick start guide) (30 min)

---

## 📋 DELIVERABLES

```yaml
shared-infrastructure/
├── docker-compose.yml       # Services: Ollama, RAGNA, Prometheus, Grafana
├── .env.example             # OLLAMA_API_URL, RAGNA_API_URL, etc.
├── scripts/
│   ├── install.sh           # One-command setup
│   ├── health-check.sh      # Monitor services
│   └── update.sh            # Upgrade services
└── README.md                # Quick start guide
```

---

## 🐳 DOCKER COMPOSE SPECIFICATION

**Services Configuration:**

```yaml
services:
  ollama:
    image: ollama/ollama:latest
    ports: ["11434:11434"]
    volumes: ["ollama-data:/root/.ollama"]
    healthcheck: 
      test: "curl -f http://localhost:11434/api/tags"
      interval: 30s
      timeout: 10s
      retries: 3
  
  ragna:
    build: ./ragna
    ports: ["31476:31476"]
    environment:
      - RAGNA_CONFIG=/app/ragna.toml
    depends_on: 
      - ollama
    healthcheck: 
      test: "curl -f http://localhost:31476/health"
      interval: 30s
      timeout: 10s
      retries: 3
  
  prometheus:
    image: prom/prometheus:latest
    ports: ["9090:9090"]
    volumes: 
      - "./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml"
      - "prometheus-data:/prometheus"
  
  grafana:
    image: grafana/grafana:latest
    ports: ["3000:3000"]
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes: 
      - "./grafana/dashboards:/etc/grafana/dashboards"
      - "grafana-data:/var/lib/grafana"

volumes:
  ollama-data:
  prometheus-data:
  grafana-data:
```

---

## 🎯 ACCEPTANCE CRITERIA

### Functional Requirements
- [ ] `docker-compose up -d` successfully starts all 4 services
- [ ] Ollama responds on `http://localhost:11434/api/tags`
- [x] Prometheus scrapes metrics from Ollama and RAGNA
- [x] Grafana accessible at `http://localhost:3000`

### Non-Functional Requirements
- [ ] All services have health checks configured
- [ ] Service startup order enforced (Ollama → RAGNA → monitoring)
- [ ] Data persistence via named volumes
- [ ] Automatic restart on failure (restart: unless-stopped)
- [ ] Installation completes in <10 minutes

### Documentation Requirements
- [ ] README.md includes quick start guide
- [ ] Environment variables documented in .env.example
- [ ] Troubleshooting section for common issues
- [ ] Architecture diagram showing service dependencies

---

## 🔗 DEPENDENCIES

**Blocks:**
- [PlayRAGNA Phase 3.2](../playragna/phase_3.2_ragna_integration.md) - Ragna API Integration
- [workflow-engine Phase 0.3](../workflow-engine/phase_0.3_cli_core.md) - CLI Core Implementation

**Blocked By:**
- None (This is the CRITICAL PATH start)

**Related Tasks:**
- [0.S.2: GPU Configuration](0.S.2_gpu_configuration.md) - Adds GPU support
- [0.S.3: Monitoring Setup](0.S.3_monitoring_setup.md) - Enhances monitoring

---

## 📊 METRICS

**Performance Targets:**
- Ollama inference: 5-10s (CPU baseline)
- RAGNA query response: <2s (without complex RAG)
- Service startup: <5 minutes
- Health check response: <1s

**Quality Targets:**
- Zero failed health checks after 5 minutes uptime
- Service uptime: 99.5%+ target
- Installation success rate: 95%+ (cross-platform)

---

## 🔍 TESTING PLAN

### Smoke Tests
```bash
# Test 1: Services start
docker-compose up -d
docker-compose ps | grep -c "Up" # Should be 4

# Test 2: Health checks pass
curl http://localhost:11434/api/tags
curl http://localhost:31476/health
curl http://localhost:9090/-/healthy
curl http://localhost:3000/api/health

# Test 3: Inter-service communication
# (RAGNA can reach Ollama)
docker-compose logs ragna | grep "Connected to Ollama"
```

### Integration Tests
- PlayRAGNA Bridge connects to shared Ollama
- workflow-engine CLI connects to shared Ollama
- Prometheus scrapes metrics from both services
- Grafana displays dashboards with live data

---

## 📝 IMPLEMENTATION NOTES

**Phase 0.R Research Foundation:**
- Based on [Docker Desktop MCP Research](../../workflow-engine/docs/Docker_Desktop_MCP_Research_Part1.md)
- Architecture validated in [Priority Matrix](../../workflow-engine/docs/Priority_Matrix_Docker_MCP.md)
- GPU enhancement deferred to Task 0.S.2

**Known Issues:**
- macOS Apple Silicon: Docker GPU support limited (fallback to CPU)
- Windows: Requires Docker Desktop with WSL2 backend
- Linux: Native Docker Engine with nvidia-docker2

---

## 🔄 UPDATE LOG

| Date | Status | Notes |
|------|--------|-------|
| 2025-01-16 | Created | Task extracted from MASTER-ROADMAP_PHASE_0.S_SHARED_INFRA.md |

---

**Parent Document:** [MASTER-ROADMAP.md](../../MASTER-ROADMAP.md#week-1)  
**Phase Documentation:** [MASTER-ROADMAP_PHASE_0.S_SHARED_INFRA.md](../../workflow-engine/.windsurf/MASTER-ROADMAP_PHASE_0.S_SHARED_INFRA.md)  
**Next Task:** [0.S.2: GPU Configuration](0.S.2_gpu_configuration.md)
